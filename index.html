<!DOCTYPE html>
<html>
<head>

<title>ConorCo Industries Ltd.</title>

<style>
body {
	perspective: 1200px;
	perspective-origin: 50% 100px;
	overflow: hidden;
}
body, html {
	display: table;
	margin: 0;
	width: 100%;
	height: 100%;
}

@font-face {
	font-family: 'industrial';
	/* from http://www.1001fonts.com/messing-lettern-font.html */
	src: url('fonts/messing-lettern.ttf');
}
@font-face {
	font-family: 'typewriter';
	/* from http://www.1001fonts.com/pelkistettya-todellisuutta-font.html */
	src: url('fonts/pelkistettya-todellisuutta.ttf');
}

.company {
	display: table-cell;
	text-align: center;
	vertical-align: middle;
}
h1, h2 {
	margin: 0px;
	font-weight: normal;
}
h1 {
	font-family: 'industrial';
	font-size: 120px;
}
h2 {
	font-family: 'typewriter';
	font-size: 59px;
}
h1 span, h2 span {
	display: inline-block;
}

.box {
	position: absolute;
	width: 0px;
	transform-style: preserve-3d;
}
.box > * {
	backface-visibility: hidden;
	position: absolute;
	text-align: center;
	transform-origin: top left;
}

.left	{ background: #f00; }
.right	{ background: #700; }
.front	{ background: #0f0; }
.back	{ background: #070; }
.top	{ background: #00f; }
.bottom	{ background: #77f; }
</style>

<script>
/* Chooses a random point inside a unit-sphere. (Not normalized to the surface.) */
function randSphere() {
	/* too slow */
	/*
	var phi = Math.random() * 2 * Math.PI;
	var costheta = Math.random() * 2 - 1;
	var theta = Math.acos(costheta);
	var x = Math.sin(theta) * Math.cos(phi);
	var y = Math.sin(theta) * Math.sin(phi);
	var z = costheta;
	return [x, y, z];
	*/

	/* non-deterministic runtime, but empirically faster */
	var x, y, z, mag;
	do {
		x = Math.random() * 2 - 1;
		y = Math.random() * 2 - 1;
		z = Math.random() * 2 - 1;
		mag = x*x + y*y + z*z;
	} while (mag >= 1);
	return [x, y, z];
}

function randRot3d(angle) {
	var vector = randSphere().join(', ');
	if (angle === undefined)
		angle = Math.random() / 2 + 'turn';
	return 'rotate3d('+vector+', '+angle+')';
}

function Box(l,w,h) {
	this.l = l;
	this.w = w;
	this.h = h;
	this.box = document.createElement('div');
	this.box.className = 'box';
	this.sides = {
		left: {w: l, h: h, xform: 'T3d(-W,-H,-L) RY(-90D)'},
		right: {w: l, h: h, xform: 'T3d(W,-H,L) RY(90D)'},
		front: {w: w, h: h, xform: 'T3d(-W,-H,L)'},
		back: {w: w, h: h, xform: 'T3d(W,-H,-L) RY(180D)'},
		top: {w: w, h: l, xform: 'T3d(-W,-H,-L) RX(90D)'},
		bottom: {w: w, h: l, xform: 'T3d(-W,H,L) RX(-90D)'},
	};
	for (name in this.sides) {
		var side = this.sides[name];

		side.canvas = document.createElement('canvas');
		side.canvas.width = side.w;
		side.canvas.height = side.h;
		side.canvas.className = name;
		side.ctx = side.canvas.getContext('2d');

		function replaceMap(str, map) {
			for (s in map)
				str = str.replace(s, map[s]);
			return str;
		}

		if (side.xform) {
			side.canvas.style.transform = replaceMap(side.xform, {
				R: 'rotate',
				T: 'translate',
				D: 'deg',
				L: (l/2) + 'px',
				W: (w/2) + 'px',
				H: (h/2) + 'px',
			});
		}

		this.box.appendChild(side.canvas);
	}
}
Box.prototype.reorient = function() {
	this.baseTransformation = randRot3d();
	if (!this.box.style.transform)
		this.box.style.transform = this.baseTransformation;
};
Box.prototype.spin = function(hz) {
	var otherTransforms = '';
	[this.baseTransformation].forEach(function(x) {
		if (x) otherTransforms += ' ' + x;
	});
	var spin = this.box.animate([
		{transform: randRot3d('0turn') + otherTransforms},
		{transform: randRot3d('1turn') + otherTransforms}
	], {duration: 1000 / hz, iterations: Infinity});
	return spin;
};
Box.prototype.decorate = function(source, uvs) {
	var that = this;
	var box = this.box;
	var sides = this.sides;
	for (side in uvs) {
		var ctx = sides[side].ctx;
		uvs[side].forEach(function(uv) {
			cw = ctx.canvas.width;
			ch = ctx.canvas.height;
			var s = uv.s || [];
			var d = uv.d || [];
			var dx = d[0] || 0;
			var dy = d[1] || 0;
			var dw = d[2] || ctx.canvas.width - dx;
			var dh = d[3] || ctx.canvas.height - dy;
			var sx = s[0] || 0;
			var sy = s[1] || 0;
			var sw = s[2] || source.width - sx;
			var sh = s[3] || source.width - sx;
			if (uv.r) {
				ctx.save();
				ctx.translate(cw/2, ch/2);
				ctx.rotate(uv.r);
				ctx.translate(-cw/2, -ch/2);
			}
			ctx.drawImage(source, sx, sy, sw, sh, dx, dy, dw, dh);
			if (uv.r)
				ctx.restore();
		});
	}
};
Box.prototype.wrap = function(texture, scale) {
	scale |= 1;
	var that = this;
	function srcUV(side) {
		var w = that.sides[side].w * scale;
		var h = that.sides[side].h * scale;
		if (w > texture.width) w = texture.width;
		if (h > texture.height) h = texture.height;
		var x = Math.random() * (texture.width - w);
		var y = Math.random() * (texture.height - h);
		return [x, y, w, h];
	}
	that.decorate(texture, {
		left: [{s:srcUV('left')}],
		right: [{s:srcUV('right')}],
		front: [{s:srcUV('front')}],
		back: [{s:srcUV('back')}],
		top: [{s:srcUV('top')}],
		bottom: [{s:srcUV('bottom')}],
	});
};
Box.prototype.tape = function(texture, width, start, stop, startAcross, stopAcross) {
	var that = this;
	var can = document.createElement('canvas');
	var ctx = can.getContext('2d');
	function toPx(len) {
		var fulls = Math.floor(len);
		var partial = len - fulls;
		var fronts = Math.ceil(fulls / 2);
		var tops = Math.floor(fulls / 2);
		var partialPx = partial * (fronts > tops ? that.l : that.h);
		var px = fronts * that.h + tops * that.l + partialPx;
		return px;
	}
	var pxAround = toPx(stop) - toPx(start);
	var pxAcross = this.w * (stopAcross - startAcross);
	var len = Math.sqrt(pxAround*pxAround + pxAcross*pxAcross);
	var theta = Math.atan2(pxAround, pxAcross) - Math.PI/2;

	/* TODO: Could be improved w/ rendered margins. */
	can.width = this.w;
	var textureUnitHeight = texture.height * width / texture.width;
	can.height = toPx(Math.ceil(stop));
	ctx.save();
	ctx.translate(startAcross * this.w - width / 2, toPx(start));
	ctx.rotate(-theta);
	for (var y = 0; y < len; y += textureUnitHeight - 1) {
		var remaining = (len - y)/textureUnitHeight;
		if (remaining > 1) remaining = 1;
		ctx.drawImage(texture, 0, 0, texture.width, texture.height * remaining, 0, y, width, textureUnitHeight * remaining);
	}
	ctx.restore();

	/* XXX FIXME: generalize past stop < 3 */
	that.decorate(can, {
		front: [{s:[0, this.h+this.l, this.w, this.h]}],
		top: [{s:[0, this.h, this.w, this.l]}],
		back: [{s:[0, 0, this.w, this.h], r:Math.PI}],
	});
};

function AssetCollection(init) {
	this.array = init || [];
}
AssetCollection.prototype.get = function(ind) {
	if (ind === undefined)
		return this.array[Math.floor(Math.random()*this.array.length)];
	else
		return this.array[ind];
};
AssetCollection.prototype.getAll = function() {
	return this.array.slice();
};
AssetCollection.prototype.add = function(x) {
	this.array.push(x);
};

var Assets = {};

/* Royalty-free images from lostandtaken.com. */
Assets.cardboards = new AssetCollection();
for (i = 1; i <= 9; i++) {
	var img = new Image();
	img.src = 'cardboards/'+i+'.jpg';
	Assets.cardboards.add(img);
}

Assets.tapes = new AssetCollection([
	'amazonprime.jpg', /* Just rotated amazon's official logo a bit. */
].map(function(tape) {
	var img = new Image();
	img.src = 'tapes/'+tape;
	return img;
}));

addEventListener('click', function(e) {
	function randLWH() { return (Math.random() * 2 + 1) * 100; }
	var box = new Box(randLWH(), randLWH(), randLWH());

	box.box.style.left = e.clientX+'px';
	box.box.style.top = e.clientY+'px';

	var cardboard = Assets.cardboards.get();
	box.wrap(cardboard, 2);

	box.reorient();
	var hz = (Math.random()/2 + Math.random()) * Math.random();
	box.spin(hz);

	var tapeWidth = 60; /* px */
	var tapeVariance = 0.1; /* percent of box-width */
	var tapeHang = 0.25; /* percent of box-height */
	box.tape(Assets.tapes.get(), tapeWidth, 1-tapeHang, 2+tapeHang,
	    (1-tapeVariance)/2 + Math.random() * tapeVariance,
	    (1-tapeVariance)/2 + Math.random() * tapeVariance);

	document.body.appendChild(box.box);
});

</script>

</head>
<body>

<div class="company">
	<h1><span>ConorCo</span> <span>Industries Ltd.</span></h1>
	<h2><span>Engineering solutions,</span> <span>one box at a time.</span></h2>
</div>

</body>
</html>
